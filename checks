-- Checks

--SELECT [ReferralBrcid]
--      ,[Referral_id]
--      ,[Event_id]
--      ,[Event_start_date]
--      ,[referral_accepted_date]
--      ,[referral_end_date]
--      ,[spell_number]
--      ,[sixmonthsto1year_OA_Mirt]
--  FROM [SQLCRIS_User].[dbo].[Afernandes_fc_3mons]

--where DATEDIFF(DD, [Event_start_date], [sixmonthsto1year_OA_Mirt]) < 91.2 
--and [sixmonthsto1year_OA_Mirt] != '1900-01-01 00:00:00.000'

-- this is within three months of each patients first f2f date
-- forgot to change sixmonthsto1year to threemonths








SELECT * 

INTO SQLCRIS_User.dbo.Afernandes_CBT

FROM 

(


SELECT * FROM 

(
SELECT Event_start_date, Event_id, Session_date, CBT.Session_n,CBT.Therapy_type, CN_DOC_ID as CBT_cndocid, ReferralBrcid,
ROW_NUMBER  () 
OVER (PARTITION BY 			ReferralBrcid
							ORDER BY CN_DOC_ID, 
							CN_DOC_ID desc, 
							CN_DOC_ID
) as ranked_cbt 

FROM [SQLCRIS_User].[dbo].[Afernandes_fc_3mons] as FC

LEFT JOIN

SQLCRISIMPORT.dbo.tbl_cbt_combined_current as CBT

ON CBT.BRCID = FC.ReferralBrcid

WHERE DATEDIFF(D, Session_date, Event_start_date) <= 91.2
)TableB

WHERE ranked_cbt =  1

)TableCBT
















